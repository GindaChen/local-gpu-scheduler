#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────
#  srun-server — start/stop the GPU scheduler server
# ─────────────────────────────────────────────────────────────
set -euo pipefail

SRUN_DIR="$(cd "$(dirname "$0")" && pwd)"

if [[ -t 1 ]]; then
  BOLD=$'\033[1m'  DIM=$'\033[2m'  RST=$'\033[0m'
  GRN=$'\033[32m'  RED=$'\033[31m'
else
  BOLD="" DIM="" RST="" GRN="" RED=""
fi

usage() {
  cat <<EOF
${BOLD}srun-server${RST} — manage the GPU scheduler server

${BOLD}Usage:${RST}
  srun-server start [--port PORT]   Start server + TUI in a tmux session
  srun-server stop                  Stop the daemon
  srun-server fg [--port PORT]      Run server in foreground (no tmux)
  srun-server tui                   Open the TUI dashboard
  srun-server status                Check if running

${DIM}Default port: 9123${RST}
EOF
}

case "${1:-}" in
  start)
    shift
    # Launch server + TUI in a tmux session with split panes
    if tmux has-session -t gpusched 2>/dev/null; then
      echo "${GRN}Session 'gpusched' already running. Attach with: tmux attach -t gpusched${RST}"
      exit 0
    fi
    tmux new-session -d -s gpusched -n server "python3 $SRUN_DIR/run_server.py $*"
    sleep 0.5
    tmux split-window -t gpusched -v "python3 $SRUN_DIR/srun-tui"
    tmux select-pane -t gpusched:0.0
    echo "${GRN}✓ Scheduler started in tmux session 'gpusched'${RST}"
    echo "${DIM}  Attach with: tmux attach -t gpusched${RST}"
    ;;
  stop)
    if tmux has-session -t gpusched 2>/dev/null; then
      tmux kill-session -t gpusched
      echo "${GRN}✓ Stopped tmux session 'gpusched'${RST}"
    else
      # Fallback: find by port
      pid=$(lsof -ti :${GPUSCHED_PORT:-9123} 2>/dev/null | head -1 || true)
      if [ -n "$pid" ]; then
        kill "$pid" 2>/dev/null && echo "${GRN}✓ Stopped (pid=$pid)${RST}"
      else
        echo "${DIM}No scheduler found running${RST}"
      fi
    fi
    ;;
  fg)
    shift
    python3 "$SRUN_DIR/run_server.py" "$@"
    ;;
  tui)
    python3 "$SRUN_DIR/srun-tui"
    ;;
  status)
    curl -sf http://localhost:${GPUSCHED_PORT:-9123}/status | python3 -m json.tool 2>/dev/null \
      && echo "${GRN}✓ Server is running${RST}" \
      || echo "${RED}✗ Server is not running${RST}"
    ;;
  -h|--help|"")
    usage ;;
  *)
    echo "${RED}Unknown command '$1'${RST}" >&2; usage; exit 1 ;;
esac
