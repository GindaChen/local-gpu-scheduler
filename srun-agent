#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────
#  srun-agent — run srun, read failures, adjust GPUs, retry
#  Always goes through srun — never bypasses the scheduler.
# ─────────────────────────────────────────────────────────────
set -euo pipefail

SRUN_DIR="$(cd "$(dirname "$0")" && pwd)"
SRUN="$SRUN_DIR/srun"
MAX_RETRIES=3

# ── colours ─────────────────────────────────────────────────
if [[ -t 1 ]]; then
  BOLD=$'\033[1m'  DIM=$'\033[2m'  RST=$'\033[0m'
  GRN=$'\033[32m'  YLW=$'\033[33m'  RED=$'\033[31m'
else
  BOLD="" DIM="" RST="" GRN="" YLW="" RED=""
fi

usage() {
  cat <<EOF
${BOLD}srun-agent${RST} — run srun with auto-retry on GPU errors

${BOLD}Usage:${RST}
  srun-agent [-n NUM_GPUS] [--max-retries N] command [args...]

${BOLD}Options:${RST}
  -n, --num-gpus N     Starting GPU count (default: 1)
  --max-retries N      Max retry attempts  (default: 3)

${BOLD}Example:${RST}
  srun-agent python train.py
  srun-agent -n 2 torchrun --nproc_per_node=4 train.py

${DIM}On failure, reads the log and adjusts GPU count if possible.${RST}
EOF
}

# ── Parse our flags ─────────────────────────────────────────
ngpus=1
while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--num-gpus)    ngpus="$2"; shift 2 ;;
    --max-retries)    MAX_RETRIES="$2"; shift 2 ;;
    -h|--help)        usage; exit 0 ;;
    -*)               break ;;  # pass unknown flags to the command
    *)                break ;;
  esac
done

[[ $# -eq 0 ]] && { usage >&2; echo "${RED}error: no command given${RST}" >&2; exit 1; }

CMD=("$@")

# ── Analyze log for GPU fix (small Python helper) ───────────
suggest_gpus() {
  local log_file="$1" current_n="$2"
  python3 -c "
import re, sys
log = open('$log_file').read()
n = $current_n

# nproc_per_node mismatch
m = re.search(r'nproc_per_node.*?(\d+).*?CUDA.*?(\d+)', log)
if m and int(m.group(1)) != n:
    print(int(m.group(1))); sys.exit(0)

# world_size mismatch
m = re.search(r'world.size.*?(\d+).*?(?:gpu|device|cuda).*?(\d+)', log, re.I)
if m and int(m.group(1)) != n:
    print(int(m.group(1))); sys.exit(0)

# nproc in the command line
for arg in '''${CMD[*]}'''.split():
    m = re.match(r'--nproc_per_node=(\d+)', arg)
    if m and int(m.group(1)) != n:
        print(int(m.group(1))); sys.exit(0)

# OOM — can't fix with more GPUs
if re.search(r'CUDA out of memory|OutOfMemoryError', log):
    print('OOM'); sys.exit(0)

# nothing found
print(''); sys.exit(0)
" 2>/dev/null || echo ""
}

# ── Retry loop ──────────────────────────────────────────────
for attempt in $(seq 1 "$MAX_RETRIES"); do
  echo "${DIM}srun-agent: attempt ${attempt}/${MAX_RETRIES} → srun -n ${ngpus} ${CMD[*]}${RST}"

  log_file=$(mktemp /tmp/srun_agent_XXXXXX.log)

  # Run through srun, capture output with script (preserves colors)
  set +e
  script -q -c "$SRUN -n $ngpus ${CMD[*]}" "$log_file"
  rc=$?
  set -e

  if [[ $rc -eq 0 ]]; then
    echo "${GRN}srun-agent: ✓ success${RST}"
    rm -f "$log_file"
    exit 0
  fi

  # Read log, suggest fix
  suggestion=$(suggest_gpus "$log_file" "$ngpus")

  if [[ "$suggestion" == "OOM" ]]; then
    echo "${RED}srun-agent: ✗ CUDA out of memory — more GPUs won't help${RST}"
    echo "${DIM}srun-agent: log: $log_file${RST}"
    exit "$rc"
  fi

  if [[ -z "$suggestion" || "$suggestion" == "$ngpus" ]]; then
    echo "${RED}srun-agent: ✗ failed (exit $rc), no GPU fix found${RST}"
    echo "${DIM}srun-agent: log: $log_file${RST}"
    exit "$rc"
  fi

  echo "${YLW}srun-agent: ✗ failed with ${ngpus} GPU(s), retrying with ${suggestion}${RST}"
  ngpus="$suggestion"
  rm -f "$log_file"
done

echo "${RED}srun-agent: ✗ exhausted ${MAX_RETRIES} retries${RST}"
exit 1
